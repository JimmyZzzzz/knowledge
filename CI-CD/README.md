# CI/CD - 持续集成与持续部署

当下 CI/CD 工具众多，有开源的也有 Online 的，有的复杂但功能强大(Jenkins)，有的虽然简单却也五脏俱全。

功能强大（大而全），可能也意味着更高的学习使用成本。
另外新出的很多 CI/CD 是完全 GitOps 的，算是小而美，使用简单，但是某些功能可能就无法通过它们实现（比如定时任务、手动指定参数进行构建等）。

可以考虑使用一个功能强大的 CI/CD 工具 hold 住全场，也可以组合一些小而美的 CI/CD 工具实现需求。
想知道具体要应该选择哪些 CI/CD 工具，就需要先分析清楚自己的需求，以及各工具都提供了什么东西给我们。


## CI/CD 功能对比

### 1. Jenkins

Jenkins 无疑是目前市面上最强大的 CI/CD 工具，可以 hold 住绝大部分的 CI/CD 使用场景。

它使用 Jenkins Pipeline 编写任务流程，有众多插件支持各类 CI/CD 功能。

每个任务都提供多种构建方式：

1. 手动设定参数，启动构建。
2. 定时使用默认参数构建，可用于各类定时任务。
3. 通过 webhook 等方式启动构建，常用于让 Git 操作自动触发构建。
4. 通过 http api 启动构建，适合于 python 等编程使用。

可以使用 Jenkins+Python 代码，打造出一个自动化运维平台。包含：

1. 前后端代码的 CI/CD
2. 自动化测试平台，通过定时任务进行自动化测试，使用 ningx/ftp 仓库进行测试记录的保存与查看，通过邮件通知或钉钉插件实现告警，。
3. CMDB 配置管理系统 资产管理系统：提供数据定时清理、服务器维护、k8s集群维护、其他资源维护等等 CMDB 功能。
   1. 比如通过 Jenkins 调用 ansible/terraform/kubeadm 等工具，进行服务器/云资源/kubernetes集群的维护。

但是 Jenkins 也存在很多问题，详见 [Jenkins Notes](jenkins/README.md)

因为 Jenkins 本身的这些问题，我目前正在寻找替代方案——能不能用多个工具来实现上述的所有功能。


### 2. Gitlab-CI

Gitlab 去年相比 Jenkins 还有很多欠缺，今年（2020）加入了多项新功能，也许有希望替换掉 Jenkins：

1. Multi-project pipelines(仅付费版): 同一个 Git 仓库可以有多个独立的 Pielines
2. Parent-Child Pipelines：可以实现层次化的 CI/CD

另外 Gitlab-CI 和 Gitlab 无缝融合，CI/CD 很方便。

Gitlab-CI 也支持定时任务、通过 API 运行 Pipeline（可自定义参数）等功能。原生支持通过邮件发送通知。

和 Jenkins 区别比较大的地方，是它没有「视图-文件夹-任务」这样的层次结构，所有的 Pipeline 其实都是附属于一个 Git 仓库的。

这样的话一些批量构建的任务，可能只能附在运维代码仓库上。尚不清楚这种组织结构合不合适。


### 3. [Drone](https://github.com/drone/drone)

Drone 是目前 Github 上最火的 CICD 项目，它以容器为核心，每个构建步骤都可以使用不同的容器镜像。
不过它在某些方面实现地比较简单，导致我们无法使用它：

1. 它不支持 Gitlab 的多层目录结构，只支持 Github 式的单层目录。
2. 流水线完全没有任何分类，我们有数量众多的流水线，不分类不方便管理。


## 我想要的 CI/CD 特性

### 1. 声明式语法

声明式语法使我们专注于具体的 CI/CD 流程，不再需要考虑实现细节。
这其实就是分离了关注点，底层的实现让别人去考虑，而我可以专注于 CI/CD 流程。

我很喜欢声明式语法，Kubernetes 的配置本身也是声明式的。
但是在 CI/CD 中，目前 jenkins pipeline 的声明式语法还是有诸多问题，越用越是不喜欢。

声明式语法需要注意的问题：

1. 错误提示一定要清晰：有些工具(Jenkins)因为使用了声明式语法，报错时直接抛出底层异常，让使用者不知所云，体验极差。
1. 语法检查与补全：Jenkins 的 DSL 基本没有什么好的语法检查工具，只能靠肉眼 Debug.
   1. 目前看来最佳的流水线语言应该是 yaml


### 2. Python/Go SDK / RESTful API

CI/CD 工具需要提供一个良好的 Python/Go SDK 或者 RESTful API，供开发者进行更高阶的操作。
比如按某种顺序去自动构建一批 Pipelines。


### 3. Go/Python 语言编写

最好是使用 Go/Python 编写的，方便我们自己深入底层去了解它的内部逻辑。


### 4. Kubernetes/Docker 支持

最好要能集成 Kubernetes/Docker，方便快捷地扩缩容构建节点。


### 5. 定时任务

一个完善的 CI/CD 平台，定时任务是不可或缺的。

### 6. 流水线的分类

常见的微服务项目，往往会拆分成众多 Git 仓库（微服务）进行开发，众多的 Git 仓库会使我们创建众多的 CI/CD 流水线。
如果没有任何的分类，这一大堆的流水线如何管理，就成了一个难题。

最显见的需求：前端和后端的流水线最好能区分一下，往下细分，前端的 Web 端和客户端最好也能区分，后端的业务层和中台最好也区分开来。
