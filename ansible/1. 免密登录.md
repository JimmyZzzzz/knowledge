# Ansible 通过 SSH 协议免密登录远程主机

安装好 ansible 后，第一件事当然是连接上远程主机。

## 一、批量扫描主机指纹

ansible 使用 ssh 协议登录远程主机进行操作，我想用过 `ssh user@host` 命令的都知道，首次登录远程主机时都会有如下提示：

```shell
ryan@RYAN-MI-DESKTOP:~$ ssh user@github.com
The authenticity of host 'github.com (13.250.177.223)' can't be established.
RSA key fingerprint is SHA256:nThbg6kXUpJWGl7E1IGOCspRomTxdCARLviKw6E5SY8.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'github.com,13.250.177.223' (RSA) to the list of known hosts.
```

这里会要求你输入 yes 将主机指纹保存到本地，是一种安全措施，防止在遇到 DNS 污染或 IP 冲突等异常情况时，目标主机被冒名顶替。

现在我们需要进行批量操作，当然希望能够快速地扫描出所有主机的指纹，这里使用 ssh-keyscan 命令：

```shell
echo "
192.168.58.131
192.168.58.132
192.168.58.133
" > my-hosts
ssh-keyscan -f my-hosts >> ~/.ssh/known_hosts
# 或者添加 -H 参数，只保存主机 IP/域名的 hash 值，更安全
ssh-keyscan -H -f my-hosts >> ~/.ssh/known_hosts
```

## 使用私钥进行免密登录

大量的远程主机都使用同一个密码提供 ssh 远程登录是很不安全的，一般都建议所有主机都只开启私钥登录，禁用密码登录。相关配置在主机的 `/etc/ssh/sshd_config` 中，详细配置方法请自行搜索。

首先你需要在本地通过 `ssh-keygen` 命令生成好公私钥，默认使用 rsa 算法。

如果你是使用的虚拟机，可以基于同一个 ova 镜像创建所有虚拟机，一开始就把运维账号(如 ops)和公钥打包在 ova 中。

或者你可以在安装所有主机时，给所有远程主机都打开密码登录，然后通过 ansible 来批量添加 ssh 公钥到所有主机上，流程如下：

首先编写一个名叫 `add-sshkey.yml` 的 playbook:

```yaml
---
- hosts: all  # 使用 inventory 中的所有主机
  gather_facts: false
  remote_user: root  # 使用这个账号登录远程主机

  tasks:
  - name: install ssh key
    authorized_key:  # 查看该 module 的文档：`ansible-doc authorized_key`
      user: root   # 给远程主机上的这个用户添加公钥。建议不要直接使用 root 账号（可以用 ops）
      key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"  # 也可以使用 url，这样公钥可以直接放 nginx 上挂着，更方便。
      state: present
```

然后用如下命令运行这个 playbook，输入密码，就能在所有远程主机上添加好 ssh 公钥：

```shell
# --inventory 指定主机清单，就用我们之前进行 ssh-keyscan 时用的那个文件就行
# --ask-pass 可以让我们交互式地输入主机密码（所有主机的密码必须相同）
ansible-playbook --inventory my-hosts ssh-addkey.yml --ask-pass
```

如果各主机的 ssh 端口、密码等参数不一致，就需要在 `my-hosts` 中设定更详细的参数，详见 [Ansible Docs - intro_inventory](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html)




